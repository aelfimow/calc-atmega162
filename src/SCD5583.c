#include "SCD5583.h"

const uint8 char_table[] PROGMEM = {
    0x00, 0x20, 0x40, 0x60, 0x80, /*   */
    0x04, 0x24, 0x44, 0x60, 0x84, /* ! */
    0x0A, 0x2A, 0x40, 0x60, 0x80, /* " */
    0x0A, 0x3F, 0x4A, 0x7F, 0x8A, /* # */
    0x0F, 0x34, 0x4E, 0x65, 0x9E, /* $ */
    0x19, 0x3A, 0x44, 0x6B, 0x93, /* % */
    0x08, 0x34, 0x4D, 0x72, 0x8D, /* & */
    0x00, 0x00, 0x00, 0x00, 0x00, /* ' */
    0x02, 0x24, 0x44, 0x64, 0x82, /* ( */
    0x08, 0x24, 0x44, 0x64, 0x88, /* ) */
    0x15, 0x2E, 0x5F, 0x6E, 0x95, /* * */
    0x04, 0x24, 0x5F, 0x64, 0x84, /* + */
    0x00, 0x2C, 0x4C, 0x64, 0x88, /* , */
    0x00, 0x20, 0x5F, 0x60, 0x80, /* - */
    0x00, 0x20, 0x40, 0x6C, 0x8C, /* . */
    0x01, 0x22, 0x44, 0x68, 0x90, /* / */
    0x0E, 0x33, 0x55, 0x79, 0x8E, /* 0 */
    0x04, 0x2C, 0x44, 0x64, 0x8E, /* 1 */
    0x0E, 0x31, 0x46, 0x68, 0x9F, /* 2 */
    0x1E, 0x21, 0x4E, 0x61, 0x9E, /* 3 */
    0x06, 0x2A, 0x5F, 0x62, 0x82, /* 4 */
    0x1F, 0x30, 0x5E, 0x61, 0x9E, /* 5 */
    0x06, 0x28, 0x5E, 0x71, 0x8E, /* 6 */
    0x1F, 0x22, 0x44, 0x68, 0x88, /* 7 */
    0x0E, 0x31, 0x4E, 0x71, 0x8E, /* 8 */
    0x0E, 0x31, 0x4F, 0x62, 0x8C, /* 9 */
    0x0C, 0x2C, 0x40, 0x6C, 0x8C, /* : */
    0x04, 0x24, 0x40, 0x64, 0x84, /* ; */
    0x02, 0x24, 0x48, 0x64, 0x82, /* < */
    0x00, 0x3F, 0x40, 0x7F, 0x80, /* = */
    0x08, 0x24, 0x42, 0x64, 0x88, /* > */
    0x0E, 0x31, 0x42, 0x64, 0x84, /* ? */
    0x0E, 0x35, 0x57, 0x70, 0x8E, /* @ */
    0x04, 0x2A, 0x5F, 0x71, 0x91, /* A */
    0x1E, 0x29, 0x4E, 0x69, 0x9E, /* B */
    0x0F, 0x30, 0x50, 0x70, 0x8F, /* C */
    0x1E, 0x29, 0x49, 0x69, 0x9E, /* D */
    0x1F, 0x30, 0x5E, 0x70, 0x9F, /* E */
    0x1F, 0x30, 0x5E, 0x70, 0x90, /* F */
    0x0F, 0x30, 0x53, 0x71, 0x8F, /* G */
    0x11, 0x31, 0x5F, 0x71, 0x91, /* H */
    0x0E, 0x24, 0x44, 0x64, 0x8E, /* I */
    0x01, 0x21, 0x41, 0x71, 0x8E, /* J */
    0x13, 0x34, 0x58, 0x74, 0x93, /* K */
    0x10, 0x30, 0x50, 0x70, 0x9F, /* L */
    0x11, 0x3B, 0x55, 0x71, 0x91, /* M */
    0x11, 0x39, 0x55, 0x73, 0x91, /* N */
    0x0E, 0x31, 0x51, 0x71, 0x8E, /* O */
    0x1E, 0x31, 0x5E, 0x70, 0x90, /* P */
    0x0C, 0x32, 0x56, 0x72, 0x8D, /* Q */
    0x1E, 0x31, 0x5E, 0x74, 0x92, /* R */
    0x0F, 0x30, 0x4E, 0x61, 0x9E, /* S */
    0x1F, 0x24, 0x44, 0x64, 0x84, /* T */
    0x11, 0x31, 0x51, 0x71, 0x8E, /* U */
    0x11, 0x31, 0x51, 0x6A, 0x84, /* V */
    0x11, 0x31, 0x55, 0x7B, 0x91, /* W */
    0x11, 0x2A, 0x44, 0x6A, 0x91, /* X */
    0x11, 0x2A, 0x44, 0x64, 0x84, /* Y */
    0x1F, 0x22, 0x44, 0x68, 0x9F, /* Z */
    0x07, 0x24, 0x44, 0x64, 0x87, /* [ */
    0x10, 0x28, 0x44, 0x62, 0x81, /* \ */
    0x1C, 0x24, 0x44, 0x64, 0x9C, /* ] */
    0x04, 0x2A, 0x51, 0x60, 0x80, /* ^ */
    0x00, 0x20, 0x40, 0x60, 0x9F, /* _ */
    0x04, 0x24, 0x40, 0x60, 0x80, /* ' */
    0x00, 0x2E, 0x52, 0x72, 0x8D, /* a */
    0x10, 0x30, 0x5E, 0x71, 0x9E, /* b */
    0x00, 0x2F, 0x50, 0x70, 0x8F, /* c */
    0x01, 0x21, 0x4F, 0x71, 0x8F, /* d */
    0x00, 0x2E, 0x5F, 0x70, 0x8E, /* e */
    0x06, 0x28, 0x48, 0x7C, 0x88, /* f */
    0x00, 0x2F, 0x50, 0x73, 0x8F, /* g */
    0x10, 0x30, 0x56, 0x79, 0x91, /* h */
    0x04, 0x20, 0x4C, 0x64, 0x8E, /* i */
    0x00, 0x26, 0x42, 0x72, 0x8C, /* j */
    0x10, 0x30, 0x56, 0x78, 0x96, /* k */
    0x0C, 0x24, 0x44, 0x64, 0x8E, /* l */
    0x00, 0x2A, 0x55, 0x75, 0x95, /* m */
    0x00, 0x36, 0x59, 0x71, 0x91, /* n */
    0x00, 0x2E, 0x51, 0x71, 0x8E, /* o */
    0x00, 0x3E, 0x51, 0x7E, 0x90, /* p */
    0x00, 0x2F, 0x51, 0x6F, 0x81, /* q */
    0x00, 0x36, 0x58, 0x70, 0x90, /* r */
    0x00, 0x23, 0x44, 0x62, 0x8C, /* s */
    0x08, 0x3C, 0x48, 0x68, 0x86, /* t */
    0x00, 0x32, 0x52, 0x72, 0x8D, /* u */
    0x00, 0x31, 0x51, 0x6A, 0x84, /* v */
    0x00, 0x31, 0x55, 0x7B, 0x91, /* w */
    0x00, 0x32, 0x4C, 0x6C, 0x92, /* x */
    0x00, 0x31, 0x4A, 0x64, 0x98, /* y */
    0x00, 0x3E, 0x44, 0x68, 0x9E, /* z */
    0x06, 0x24, 0x48, 0x64, 0x86, /* { */
    0x04, 0x24, 0x44, 0x64, 0x84, /* | */
    0x0C, 0x24, 0x42, 0x64, 0x8C, /* } */
    0x08, 0x35, 0x42, 0x60, 0x80, /* ~ */
    0x00, 0x00, 0x00, 0x00, 0x00 /* \ */
};

static char disp_line[16];
static uint8 char_pos;

uint8 disp_wr(uint8 dispnr, uint8 data) {
    uint8 loadnr, i;
    loadnr = !dispnr ? LOAD_0_PIN: LOAD_1_PIN;
    PORTA &= (uint8)~(1 << loadnr);
    PORTA &= (uint8)~(1 << SDCLK_PIN);
    for (i = 0; i < 8; i++) {
        if (data & 1)
            PORTA |= (uint8)(1 << SDATA_PIN);
        else
            PORTA &= (uint8)~(1 << SDATA_PIN);
        wait_loop(SDCLK_T);
        PORTA |= (uint8)(1 << SDCLK_PIN);
        wait_loop(SDCLK_T);
        PORTA &= (uint8)~(1 << SDCLK_PIN);
        data >>= 1;
    }
    wait_loop(SDCLK_T);
    PORTA |= (uint8)(1 << loadnr);
    return 0;
}

uint8 disp_wrline(void) {
    uint8 i, dispnr, index, j, data;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    for (i = 0; i < limit; i++) {
        dispnr = i < 8 ? 0: 1;
        disp_wr(dispnr, (i % 8) | 0xA0);
        index = disp_line[i];
        if (index >= 32 && index <= 127) {
            index -= 32;
            for (j = 0; j < 5; j++) {
                data = pgm_read_byte_near(&char_table[5 * index + j]);
                disp_wr(dispnr, data);
            }
        } else {
            data = pgm_read_byte_near(char_table[0]);
            for (j = 0; j < 5; j++) disp_wr(dispnr, data);
        }
    }
    return 0;
}


uint8 wait_loop(uint16 max) {
    uint16 i;
    for (i = 0; i < max; i++);
    return i;
}

uint8 disp_printf(const char *str) {
    uint8 i;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    while (*str) {
        if (char_pos > limit - 1) {
            char_pos = limit - 1;
            for (i = 1; i < limit; i++)
                disp_line[i - 1] = disp_line[i];
        }
        disp_line[char_pos] = *str++;
        char_pos++;
    }
    return disp_wrline();
}

uint8 clear_disp(void) {
    uint8 i;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    for (i = 0; i < limit; i++) disp_line[i] = ' ';
    char_pos = 0;
    return disp_wr(0, 0xC0) | disp_wr(1, 0xC0);
}
